name: SFDX Code Scan

on:
  push:
    branches:
      - main
      - '**'

jobs:
  run-scanner:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: |
          npm install --global sfdx-cli

      - name: Install SFDX Scanner Plugin
        run: |
          sfdx plugins:install @salesforce/sfdx-scanner

      - name: Run SFDX Scanner
        run: |
          sfdx scanner:run --target "force-app/main/default/classes" --format "csv" --outfile "scanner-report.csv"

      - name: Encode CSV file to Base64
        id: encode_file
        run: |
          base64 scanner-report.csv | tee encoded_report.txt

          - name: Upload CSV Report to Salesforce
          run: |
            # First, create a ContentDocument
            contentDocumentResponse=$(curl -X POST https://https://sprintparksolutionspvtltd-dev-ed.develop.my.salesforce.com/services/data/v61.0/sobjects/ContentVersion/ \
              -H "Authorization: Bearer ${{ secrets.SF_ACCESS_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "Title": "Scanner Report",
                "PathOnClient": "scanner-report.csv",
                "VersionData": "'"$(cat encoded_report.txt)"'"
              }')
        
            # Extract ContentDocumentId from the response
            contentDocumentId=$(echo $contentDocumentResponse | jq -r '.id')
        
            # Optional: Log the ContentDocumentId
            echo "ContentDocumentId: $contentDocumentId"
          env:
            SF_ACCESS_TOKEN: ${{ secrets.SF_ACCESS_TOKEN }}
          shell: bash
        