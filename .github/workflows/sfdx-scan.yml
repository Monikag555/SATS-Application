on:
  push:
    branches:
      - main
      - '**'

jobs:
  run-scanner:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: |
          npm install --global sfdx-cli@latest

      - name: Install SFDX Scanner Plugin
        run: |
          sfdx plugins:install @salesforce/sfdx-scanner@latest

      - name: Authenticate to Salesforce
        run: |
          echo ${{ secrets.SFDX_AUTH_URL }} > sfdx-auth-url.txt
          sfdx auth:sfdxurl:store --sfdx-url-file sfdx-auth-url.txt --set-default --json

      - name: Run SFDX Scanner
        run: |
          sfdx scanner:run --target "force-app/main/default" --format "csv" --outfile "scanner-report.csv" --debug

      - name: Upload CSV to Salesforce Files
        run: |
          sfdx force:data:record:create -s ContentVersion -v "Title='scanner-report' PathOnClient='scanner-report.csv' VersionData=$(base64 -w 0 scanner-report.csv)" --json
